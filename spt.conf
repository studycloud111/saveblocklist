# 上游服务器配置
upstream sphk {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server 152.53.37.160:10011 id=1001 weight=3 max_fails=3 fail_timeout=30s;
}

upstream spsg {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-sg.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spjp {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-jp1.example.com:10091 max_fails=3 fail_timeout=30s;
    server sp-jp2.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spuk {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-uk.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spus {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-us.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spde {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-de.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream sptw {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-tw.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spin {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-in.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spkr {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-kr.example.com:10091 max_fails=3 fail_timeout=30s;
}

upstream spca {
    dynamic_resolve fallback=stale fail_timeout=30s;
    consistent_hash $remote_addr;
    server sp-ca.example.com:10091 max_fails=3 fail_timeout=30s;
}

map $ssl_preread_server_name $backend_pool {
    sphk.xn--e6q56cu20k.com    sphk;
    spsg.xn--e6q56cu20k.com    spsg;
    spjp.xn--e6q56cu20k.com    spjp;
    spuk.xn--e6q56cu20k.com    spuk;
    spus.xn--e6q56cu20k.com    spus;
    spde.xn--e6q56cu20k.com    spde;
    sptw.xn--e6q56cu20k.com    sptw;
    spin.xn--e6q56cu20k.com    spin;
    spkr.xn--e6q56cu20k.com    spkr;
    spca.xn--e6q56cu20k.com    spca;
}

# 通用SSL和代理配置
include /usr/local/nginx/mytcp/ssl_common.conf;
include /usr/local/nginx/mytcp/proxy_common.conf;

# 统一的服务器配置
server {
    listen 443 ssl;
    server_name *.xn--e6q56cu20k.com;
    proxy_pass $backend_pool;
}
